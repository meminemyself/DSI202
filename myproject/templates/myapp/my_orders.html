{% extends 'base.html' %}
{% block title %}คำสั่งซื้อของฉัน | PLOOKJING{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Prompt', sans-serif;
    background-color: #F3F6F9;
  }
  .orders-page {
    max-width: 1080px;
    margin: 2rem auto;
    padding: 2rem;
  }
  .orders-header {
    font-size: 2rem;
    font-weight: bold;
    color: #0D3F31;
    margin-bottom: 1.5rem;
  }
  .status-filter {
    display: flex;
    gap: 0.8rem;
    flex-wrap: wrap;
    margin-bottom: 2rem;
  }
  .status-tab {
    padding: 0.6rem 1.2rem;
    background: #E6F4EC;
    color: #0D6E3E;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    transition: 0.3s ease;
    border: 2px solid transparent;
  }
  .status-tab:hover {
    background: #CCE9DB;
  }
  .status-tab.active {
    background: #FB7E2B;
    color: white;
    border-color: #FB7E2B;
  }
  .order-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .order-item {
    background: white;
    padding: 1rem 1.2rem;
    border-radius: 14px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.04);
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    border-left: 6px solid #EFFAF3;
    transition: 0.2s ease;
  }
  .order-item:hover {
    background-color: #FAFFFC;
  }
  .order-item img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 10px;
    margin-right: 1rem;
  }
  .order-summary {
    display: flex;
    align-items: center;
    flex: 1;
    gap: 1rem;
  }
  .order-info h4 {
    font-size: 1rem;
    margin: 0;
    color: #0D3F31;
  }
  .order-info p {
    font-size: 0.9rem;
    margin: 0.2rem 0 0;
    color: #666;
  }
  .order-status {
    font-weight: bold;
    font-size: 0.95rem;
    padding: 0.3rem 0.6rem;
    border-radius: 6px;
    display: inline-block;
  }
  .status-pending { background: #FFF1E5; color: #FB7E2B; }
  .status-verifying { background: #FFFDE7; color: #F9A825; }
  .status-preparing { background: #FFF9DB; color: #B28A00; }
  .status-shipping { background: #E0F2FF; color: #0277BD; }
  .status-delivered { background: #E6F4EC; color: #0D6E3E; }
  .status-cancelled, .status-expired { background: #FFECEC; color: #D55E02; }
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    overflow-y: auto;
  }
  .modal-content {
    background-color: #fff;
    margin: 5% auto;
    padding: 2rem;
    border-radius: 14px;
    max-width: 540px;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
    font-family: 'Prompt', sans-serif;
  }
  .close {
    position: absolute;
    top: 0.8rem;
    right: 1rem;
    font-size: 2.2rem;
    color: #999;
    cursor: pointer;
  }
  .action-btn {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 10px;
    font-size: 0.9rem;
    font-weight: 600;
    text-decoration: none;
    font-family: 'Prompt', sans-serif;
    border: none;
    margin-top: 0.5rem;
  }
  .btn-slip { background: #FFF1E5; color: #FB7E2B; cursor: pointer; }
</style>

<div class="orders-page">
  <div class="orders-header">คำสั่งซื้อของฉัน</div>
  <div class="status-filter">
    {% for status, label, css_class in status_list %}
      <a href="?status={{ status }}" class="status-tab {% if request.GET.status == status %}active{% endif %}">{{ label }}</a>
    {% endfor %}
  </div>
  <div class="order-list">
    {% for order in purchases %}
      <div class="order-item" onclick="openModal('modal-{{ order.id }}')">
        <div class="order-summary">
          <img src="{{ order.equipment.image_url }}" alt="{{ order.equipment.name }}">
          <div class="order-info">
            <h4>{{ order.equipment.name }}</h4>
            <p>x {{ order.quantity }}</p>
            <p class="order-status status-{{ order.status }}">สถานะ: {{ order.get_status_display }}</p>
            <p style="font-size: 0.8rem; color: #888;">หมายเลข: {{ order.order_number }}</p>
            <p style="font-size: 0.8rem; color: #aaa;">สั่งเมื่อ {{ order.created_at|date:'d/m/Y H:i' }}</p>
          </div>
        </div>
        <div>&rsaquo;</div>
      </div>

      <div id="modal-{{ order.id }}" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeModal('modal-{{ order.id }}')">&times;</span>
          <h3>รายละเอียดคำสั่งซื้อ</h3>
          <h4>หมายเลขคำสั่งซื้อ</h4>
          <p>{{ order.order_number }}</p>
          <h4>รายการสินค้า</h4>
          <p>{{ order.equipment.name }} × {{ order.quantity }} ชิ้น ({{ order.total_price|floatformat:2 }} บาท)</p>
          <h4>ข้อมูลการจัดส่ง</h4>
          <p>{{ order.name }} ({{ order.tel }})</p>
          <p style="white-space: pre-line;">{{ order.address }}</p>
          <h4>วันที่สั่งซื้อ</h4>
          <p>{{ order.created_at|date:'d/m/Y เวลา H:i' }}</p>

          {% if order.status == 'pending' and order.qr_base64 and not order.payment_slip %}
            <h4>การชำระเงิน</h4>
            <button class="action-btn btn-slip" onclick="toggleQR('{{ order.id }}')">แสดง QR สำหรับชำระเงิน</button>
            <div id="qr-container-{{ order.id }}" style="display:none; margin-top:1rem;">
              <img src="data:image/png;base64,{{ order.qr_base64|safe }}" alt="QR Code" style="width: 200px; border-radius: 12px; border: 1px solid #ddd;">
            </div>
            <h4>แนบสลิปการชำระเงิน</h4>
            <form method="POST" action="{% url 'upload_slip' order.id %}" enctype="multipart/form-data">
              {% csrf_token %}
              <input type="file" name="payment_slip" accept="image/*" required>
              <button type="submit" class="action-btn btn-slip">อัปโหลดสลิป</button>
            </form>
            <script>startCountdown('{{ order.id }}', 300);</script>
          {% elif order.payment_slip %}

            <h4>สลิปการชำระเงิน</h4>
            <button onclick="showSlipModal('{{ order.id }}')" class="action-btn btn-slip">ดูสลิป</button>
            <div id="slip-modal-{{ order.id }}" class="modal">
              <div class="modal-content">
                <span class="close" onclick="closeModal('slip-modal-{{ order.id }}')">&times;</span>
                <img src="{{ order.payment_slip.url }}" alt="สลิป" style="max-width: 100%; border-radius: 8px;">
              </div>
            </div>
          {% endif %}

          {% if order.tracking_number and order.status == 'shipping' or order.status == 'delivered' %}
            <h4>หมายเลขพัสดุ:</h4>
            <p>{{ order.tracking_number }}</p>
          {% endif %}
        </div>
      </div>
    {% empty %}
      <p class="text-gray-500">ไม่มีคำสั่งซื้อในหมวดนี้</p>
    {% endfor %}
  </div>
</div>

<script>
  function openModal(id) {
    document.getElementById(id).style.display = 'block';
  }
  function closeModal(id) {
    document.getElementById(id).style.display = 'none';
  }
  function toggleQR(orderId) {
    const qr = document.getElementById(`qr-container-${orderId}`);
    qr.style.display = qr.style.display === 'block' ? 'none' : 'block';
  }
  function showSlipModal(id) {
    document.getElementById('slip-modal-' + id).style.display = 'block';
  }
  function startCountdown(orderId, seconds) {
    const display = document.getElementById(`countdown-${orderId}`);
    const interval = setInterval(() => {
      if (seconds <= 0) {
        clearInterval(interval);
        display.innerText = 'หมดเวลาชำระเงิน';
        autoCancel(orderId);
      } else {
        const min = Math.floor(seconds / 60);
        const sec = seconds % 60;
        display.innerText = `เหลือเวลา: ${min}:${sec.toString().padStart(2, '0')}`;
        seconds--;
      }
    }, 1000);
  }
  function autoCancel(orderId) {
    fetch(`/auto-cancel/${orderId}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    }).then(res => res.json()).then(data => {
      if (data.status === 'cancelled') location.reload();
    });
  }
</script>
{% endblock %}